<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>القرآن الكريم</title>
    <link rel="stylesheet" href="theme.css">
    <style>
        /* إضافات مخصصة للانسيابية */
        .search-container {
            padding: 10px 16px;
            position: sticky;
            top: 60px;
            background: var(--bg);
            z-index: 99;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            border-radius: 12px;
            border: 1px solid rgba(0,0,0,0.1);
            background: var(--card);
            color: var(--text);
            font-family: var(--font-ui);
            outline: none;
            border-bottom: 3px solid var(--primary);
            transition: var(--transition);
        }

        /* حاوية المصحف (النص المتصل) */
        .quran-reader {
            background: var(--card);
            margin: 15px;
            padding: 25px;
            border-radius: 20px;
            border-bottom: 5px solid var(--primary);
            box-shadow: var(--shadow);
            line-height: 2.5;
            text-align: justify;
            word-spacing: 4px;
            animation: cardAppear 0.5s ease;
        }

        .ayah-span {
            font-family: var(--font-content);
            font-size: 26px;
            cursor: pointer;
            transition: 0.2s;
            display: inline;
            padding: 2px 4px;
            border-radius: 8px;
        }

        .ayah-span:active {
            background: var(--glow-color);
            transform: scale(0.98);
        }

        .ayah-num-inline {
            font-family: 'Cairo', sans-serif;
            font-size: 18px;
            color: var(--primary);
            margin: 0 5px;
            font-weight: bold;
            user-select: none;
        }

        .bismillah {
            font-family: var(--font-content);
            font-size: 32px;
            text-align: center;
            color: var(--primary);
            display: block;
            margin-bottom: 25px;
        }

        /* ستايل التفسير (Modal) */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center;
            padding: 20px; backdrop-filter: blur(4px);
        }
        .modal-card {
            background: var(--card); padding: 25px; border-radius: 20px; width: 100%; max-width: 500px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3); animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-top: 5px solid var(--primary);
        }
        @keyframes pop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        .modal-card h3 { color: var(--primary); margin-bottom: 15px; text-align: center; font-family: var(--font-ui); }
        .modal-card p { font-size: 19px; line-height: 1.8; color: var(--text); text-align: center; font-family: var(--font-content); max-height: 60vh; overflow-y: auto; }
        
        .close-btn { width: 100%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 12px; margin-top: 20px; font-weight: bold; cursor: pointer; }

        .hint-text { text-align: center; font-size: 12px; color: var(--muted); margin-bottom: 10px; }
    </style>
</head>
<body>

    <div class="top-bar">
        <button class="icon-btn" onclick="goBack()">→</button>
        <div class="top-title" id="pageTitle">القرآن الكريم</div>
        <div style="width: 40px;"></div>
    </div>

    <div class="search-container" id="searchBox">
        <input type="text" class="search-input" id="searchInput" placeholder="ابحث عن سورة..." oninput="searchSurah()">
    </div>

    <div class="container" id="surahContainer">
        </div>

    <div class="modal-overlay" id="tafsirModal">
        <div class="modal-card">
            <h3 id="tafsirTitle">تفسير الآية</h3>
            <p id="tafsirContent">جاري جلب التفسير...</p>
            <button class="close-btn" onclick="closeTafsir()">إغلاق</button>
        </div>
    </div>

    <script>
        let allSurahs = [];
        let isReading = false;
        let pressTimer;

        window.onload = loadSurahs;

        async function loadSurahs() {
            try {
                const response = await fetch('https://api.alquran.cloud/v1/surah');
                const data = await response.json();
                allSurahs = data.data;
                displaySurahs(allSurahs);
            } catch (error) { console.error("Error:", error); }
        }

        function displaySurahs(surahs) {
            isReading = false;
            document.getElementById('searchBox').style.display = 'block';
            document.getElementById('pageTitle').textContent = "القرآن الكريم";
            const container = document.getElementById('surahContainer');
            
            container.style.display = 'grid'; // رجوع لنظام المربعات
            container.innerHTML = surahs.map(s => `
                <div class="card" onclick="loadAyahs(${s.number}, '${s.name}')">
                    <h3 style="font-size: 20px;">${s.name}</h3>
                    <p style="font-size: 12px; color: var(--muted);">${s.englishName}</p>
                    <p style="color: var(--primary); font-weight: bold; margin-top:5px;">${s.numberOfAyahs} آية</p>
                </div>
            `).join('');
            window.scrollTo(0,0);
        }

        function searchSurah() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allSurahs.filter(s => s.name.includes(term) || s.englishName.toLowerCase().includes(term));
            displaySurahs(filtered);
        }

        async function loadAyahs(num, name) {
            isReading = true;
            document.getElementById('searchBox').style.display = 'none';
            document.getElementById('pageTitle').textContent = name;
            
            try {
                const response = await fetch(`https://api.alquran.cloud/v1/surah/${num}`);
                const data = await response.json();
                const container = document.getElementById('surahContainer');
                
                container.style.display = 'block'; // تحويل الحاوية لعرض النص المتصل
                
                let html = '<div class="quran-reader">';
                if (num !== 1 && num !== 9) {
                    html += `<span class="bismillah">بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيمِ</span>`;
                }

                html += `<div class="hint-text">(اضغط مطولاً على الآية لعرض التفسير)</div>`;

                html += data.data.ayahs.map(a => `
                    <span class="ayah-span" 
                          onmousedown="startP(${num}, ${a.numberInSurah})" 
                          onmouseup="endP()" 
                          ontouchstart="startP(${num}, ${a.numberInSurah})" 
                          ontouchend="endP()"
                          oncontextmenu="event.preventDefault(); showT(${num}, ${a.numberInSurah});">
                        ${a.text} <span class="ayah-num-inline">(${a.numberInSurah})</span>
                    </span>
                `).join(' ');

                html += '</div>';
                container.innerHTML = html;
                window.scrollTo(0,0);
            } catch (error) { console.error("Error:", error); }
        }

        // منطق التفسير
        async function showT(sNum, aNum) {
            document.getElementById('tafsirContent').textContent = "جاري التحميل...";
            document.getElementById('tafsirModal').style.display = 'flex';
            try {
                const res = await fetch(`https://api.alquran.cloud/v1/ayah/${sNum}:${aNum}/ar.muyassar`);
                const data = await res.json();
                document.getElementById('tafsirTitle').textContent = `تفسير الآية رقم ${aNum}`;
                document.getElementById('tafsirContent').textContent = data.data.text;
            } catch (e) { document.getElementById('tafsirContent').textContent = "حدث خطأ في الاتصال."; }
        }

        function startP(s, a) { pressTimer = setTimeout(() => showT(s, a), 600); }
        function endP() { clearTimeout(pressTimer); }
        function closeTafsir() { document.getElementById('tafsirModal').style.display = 'none'; }

        function goBack() {
            if (isReading) displaySurahs(allSurahs);
            else window.history.back();
        }
    </script>
</body>
    </html>

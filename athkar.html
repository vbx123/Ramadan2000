<!DOCTYPE html>
<html lang="ar" dir="rtl" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حصن المسلم - الأذكار</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="theme.css">
</head>
<body>

    <div class="top-bar">
        <button class="icon-btn" onclick="goBack()" id="backBtn">→</button>
        <div class="top-title" id="topTitle">الأذكار</div>
        <div style="width: 40px;"></div> </div>

    <div class="container" id="mainContainer">
        </div>

    <div id="hadithModal">
        <h3 style="color:var(--primary); margin-bottom:15px; text-align:center;">مصدر الذكر وفضله</h3>
        <p id="hadithContent" style="font-family:var(--font-content); font-size:18px; line-height:1.6; text-align:justify;"></p>
        <button class="surah-item" style="width:100%; margin-top:20px; background:var(--primary); color:#000; font-weight:bold;" onclick="closeModal()">إغلاق</button>
    </div>

    <script>
        let currentLevel = 'categories';
        let longPressTimer;

        // 1. إدارة الثيم الموحد
        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        window.onload = () => {
            applySavedTheme();
            loadCategories();
        };

        // 2. تحميل الأقسام من Titles.json
        function loadCategories() {
            currentLevel = 'categories';
            document.getElementById('topTitle').textContent = "الأذكار";
            const container = document.getElementById('mainContainer');
            
            fetch('Data/Remember/Titles.json')
                .then(res => res.json())
                .then(data => {
                    // عرض الأقسام بشكل طولي (قائمة)
                    container.innerHTML = data.map(cat => `
                        <div class="zekr-card" onclick="loadAthkar('${cat.id}', '${cat.name}')" style="display: flex; align-items: center; gap: 20px;">
                            <img src="${cat.icon}" style="width:45px; height:45px; object-fit: contain;">
                            <h3 style="margin:0;">${cat.name}</h3>
                        </div>
                    `).join('');
                })
                .catch(err => console.error("خطأ في تحميل العناوين:", err));
        }

        // 3. تحميل الأذكار من ملف القسم المختص
        function loadAthkar(fileId, title) {
            currentLevel = 'items';
            document.getElementById('topTitle').textContent = title;
            const container = document.getElementById('mainContainer');
            
            fetch(`Data/Remember/${fileId}.json`)
                .then(res => res.json())
                .then(data => {
                    const list = data.content || data;
                    container.innerHTML = list.map((z, index) => {
                        const radius = 30;
                        const circum = 2 * Math.PI * radius;
                        return `
                        <div class="zekr-card" 
                             id="zekr-${index}" 
                             onclick="handleTap(${index}, ${z.count})"
                             onmousedown="startPress('${z.source}')" 
                             onmouseup="endPress()" 
                             ontouchstart="startPress('${z.source}')" 
                             ontouchend="endPress()"
                             data-done="0">
                            
                            <span class="zekr-text">${z.text}</span>
                            
                            <div class="counter-box">
                                <div class="progress-ring">
                                    <svg>
                                        <circle class="bg-circle" cx="35" cy="35" r="30"/>
                                        <circle class="bar-circle" id="bar-${index}" cx="35" cy="35" r="30" 
                                                style="stroke-dasharray: ${circum}; stroke-dashoffset: ${circum};"/>
                                    </svg>
                                    <div class="number-overlay" id="num-${index}">${z.count}</div>
                                </div>
                            </div>
                            <div class="source-hint">اضغط مطولاً لمعرفة الفضل</div>
                        </div>
                        `;
                    }).join('');
                    window.scrollTo(0,0);
                })
                .catch(err => console.error("خطأ في تحميل الأذكار:", err));
        }

        // 4. منطق العداد التفاعلي
        function handleTap(idx, max) {
            const card = document.getElementById(`zekr-${idx}`);
            const bar = document.getElementById(`bar-${idx}`);
            const num = document.getElementById(`num-${idx}`);
            
            let current = parseInt(card.getAttribute('data-done'));
            
            if (current < max) {
                current++;
                card.setAttribute('data-done', current);
                
                const radius = 30;
                const circum = 2 * Math.PI * radius;
                const offset = circum - (current / max) * circum;
                bar.style.strokeDashoffset = offset;
                
                // تحديث الرقم المتبقي
                num.textContent = (max - current) === 0 ? "✓" : (max - current);

                if (current === max) {
                    card.classList.add('zekr-done');
                    if(navigator.vibrate) navigator.vibrate(50); // اهتزاز بسيط
                }
            }
        }

        // 5. منطق الضغط المطول لإظهار المصدر
        function startPress(source) {
            longPressTimer = setTimeout(() => {
                document.getElementById('hadithContent').textContent = source;
                document.getElementById('hadithModal').classList.add('active');
            }, 700);
        }

        function endPress() { clearTimeout(longPressTimer); }
        function closeModal() { document.getElementById('hadithModal').classList.remove('active'); }

        // 6. زر العودة الذكي
        function goBack() {
            if (currentLevel === 'items') {
                loadCategories();
            } else {
                window.history.back();
            }
        }
    </script>
</body>
</html>
